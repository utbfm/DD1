function calculateWaitingTimeUnidadAcademica() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  
  // Définir l'arrêt Unidad Académica
  var unidadAcademica = {
    name: "Unidad Academica", 
    lat: 25.604463, 
    lng: -100.104616, 
    routeIndex: 52
  };

  // Paramètres du parcours
  var totalRoutePoints = 137;
  var intervalPerPoint = 5; // 5 secondes par point
  
  // Récupérer les données du bus 1 de la ligne EscolarJuarez
  var busSheet = sheet.getSheetByName("EscolarJuarez");
  if (!busSheet) {
    console.log("Feuille EscolarJuarez non trouvée");
    return "Erreur: Feuille non trouvée";
  }

  var busData = busSheet.getRange(2, 1, busSheet.getLastRow() - 1, 6).getValues();
  
  var bus1Data = null;
  // Chercher le bus 1 dans les données
  for (var i = 0; i < busData.length; i++) {
    if (busData[i][2] === "EscolarJuarez" && busData[i][3] == "1") {
      bus1Data = busData[i];
      break;
    }
  }
  
  if (!bus1Data) {
    console.log("Bus 1 non trouvé dans les données");
    return "Bus 1 non trouvé";
  }
  
  var busLat = bus1Data[4];
  var busLng = bus1Data[5];
  
  // Trouver la position actuelle du bus dans le parcours
  var currentBusIndex = findNearestRouteIndex(busLat, busLng);
  
  // Calculer la distance jusqu'à l'arrêt Unidad Académica
  var distanceToStop;
  if (currentBusIndex <= unidadAcademica.routeIndex) {
    // Le bus n'a pas encore atteint l'arrêt
    distanceToStop = unidadAcademica.routeIndex - currentBusIndex;
  } else {
    // Le bus a dépassé l'arrêt, il reviendra au tour suivant
    distanceToStop = (totalRoutePoints - currentBusIndex) + unidadAcademica.routeIndex;
  }
  
  var waitTimeSeconds = distanceToStop * intervalPerPoint;
  var waitTimeMinutes = waitTimeSeconds / 60;
  
  // Formatter le temps d'attente
  var waitTimeFormatted;
  if (waitTimeMinutes < 1) {
    waitTimeFormatted = Math.round(waitTimeMinutes * 60) + " secondes";
  } else {
    waitTimeFormatted = Math.round(waitTimeMinutes * 10) / 10 + " minutes";
  }
  
  // Informations de debug
  var debugInfo = {
    busPosition: "Index " + currentBusIndex + " sur le parcours",
    busCoordinates: "Lat: " + busLat + ", Lng: " + busLng,
    stopPosition: "Index " + unidadAcademica.routeIndex + " sur le parcours",
    distance: distanceToStop + " points",
    waitTime: waitTimeFormatted
  };
  
  console.log("=== CALCUL TEMPS D'ATTENTE ===");
  console.log("Arrêt: " + unidadAcademica.name);
  console.log("Bus: 1");
  console.log("Position actuelle du bus: " + debugInfo.busPosition);
  console.log("Coordonnées du bus: " + debugInfo.busCoordinates);
  console.log("Position de l'arrêt: " + debugInfo.stopPosition);
  console.log("Distance à parcourir: " + debugInfo.distance);
  console.log("Temps d'attente estimé: " + debugInfo.waitTime);
  
  return {
    arret: unidadAcademica.name,
    bus: "Bus 1",
    tempsAttente: waitTimeFormatted,
    details: debugInfo
  };
}

// Fonction pour obtenir juste le temps d'attente sous forme de texte
function getWaitTimeUnidadAcademicaBus1() {
  var result = calculateWaitingTimeUnidadAcademica();
  if (typeof result === "string") {
    return result; // Retourner l'erreur
  }
  return "Temps d'attente à " + result.arret + " pour le " + result.bus + ": " + result.tempsAttente;
}

// Fonction pour mettre à jour uniquement cette information dans une feuille
function updateUnidadAcademicaWaitTime() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet();
  var result = calculateWaitingTimeUnidadAcademica();
  
  if (typeof result === "string") {
    console.log("Erreur: " + result);
    return;
  }
  
  // Créer ou obtenir une feuille spécifique pour cette information
  var waitSheet = sheet.getSheetByName("ATTENTE_UNIDAD_ACADEMICA");
  if (!waitSheet) {
    waitSheet = sheet.insertSheet("ATTENTE_UNIDAD_ACADEMICA");
    // En-têtes
    waitSheet.getRange(1, 1, 1, 4).setValues([["Arrêt", "Bus", "Temps d'Attente", "Dernière MAJ"]]);
    waitSheet.getRange(1, 1, 1, 4).setFontWeight("bold");
    waitSheet.getRange(1, 1, 1, 4).setBackground("#FE8304");
    waitSheet.getRange(1, 1, 1, 4).setFontColor("white");
  }
  
  var now = new Date();
  var currentTime = Utilities.formatDate(now, "GMT-6", "HH:mm:ss dd/MM/yyyy");
  
  // Mettre à jour les données
  waitSheet.getRange(2, 1, 1, 4).setValues([[
    result.arret,
    result.bus,
    result.tempsAttente,
    currentTime
  ]]);
  
  // Formatage conditionnel
  var waitTimeCell = waitSheet.getRange(2, 3);
  var timeText = result.tempsAttente;
  
  if (timeText.includes("seconde") || (timeText.includes("minute") && parseFloat(timeText) <= 2)) {
    waitTimeCell.setBackground("#d4edda").setFontColor("#155724"); // Vert - imminent
  } else if (timeText.includes("minute") && parseFloat(timeText) <= 5) {
    waitTimeCell.setBackground("#fff3cd").setFontColor("#856404"); // Jaune - bientôt
  } else {
    waitTimeCell.setBackground("#f8d7da").setFontColor("#721c24"); // Rouge - longue attente
  }
  
  waitSheet.autoResizeColumns(1, 4);
  
  console.log("Feuille mise à jour avec: " + result.tempsAttente);
}
